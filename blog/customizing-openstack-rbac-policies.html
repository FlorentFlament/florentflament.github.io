<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8" />
  <title>Customizing OpenStack RBAC policies | Florent Flament 2 cents</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="http://www.florentflament.com/blog/static/m-dark.css" />
  <link rel="canonical" href="http://www.florentflament.com/blog/customizing-openstack-rbac-policies.html" />
  <link href="http://www.florentflament.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Florent Flament 2 cents" />
  <link href="http://www.florentflament.com/blog/feeds/openstack.atom.xml" type="application/atom+xml" rel="alternate" title="Florent Flament 2 cents | OpenStack" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
  <meta property="og:site_name" content="Florent Flament 2 cents" />
  <meta property="og:title" content="Customizing OpenStack RBAC policies" />
  <meta name="twitter:title" content="Customizing OpenStack RBAC policies" />
  <meta property="og:url" content="http://www.florentflament.com/blog/customizing-openstack-rbac-policies.html" />
  <meta property="og:description" content="OpenStack uses a role based access control (RBAC) mechanism to manage accesses to its resources. With the current architecture, users&#39; roles granted on each project and domain are stored into Keystone, and can be updated through Keystone&#39;s API. However, policy enforcement (actually allowing or not the access to resources according …" />
  <meta name="twitter:description" content="OpenStack uses a role based access control (RBAC) mechanism to manage accesses to its resources. With the current architecture, users&#39; roles granted on each project and domain are stored into Keystone, and can be updated through Keystone&#39;s API. However, policy enforcement (actually allowing or not the access to resources according …" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:type" content="article" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="http://www.florentflament.com/blog/" id="m-navbar-brand" class="m-col-t-9 m-col-m-none m-left-m">Florent Flament 2 cents</a>
    </div>
  </div>
</nav></header>
<main>
<div class="m-container">
  <div class="m-row">
    <article class="m-col-m-10 m-nopadb">
      <header>
        <h1><a href="http://www.florentflament.com/blog/customizing-openstack-rbac-policies.html" rel="bookmark" title="Permalink to Customizing OpenStack RBAC policies">
          <time class="m-date" datetime="2014-02-09T00:00:00+01:00">
            Feb <span class="m-date-day">09</span> 2014
          </time>
          Customizing OpenStack RBAC policies
        </a></h1>
      </header>
      <div class="m-clearfix-l"></div>
<!-- content -->
<p>OpenStack uses a <a href="http://docs.openstack.org/developer/keystone/configuration.html#keystone-api-protection-with-role-based-access-control-rbac">role based access control</a> (RBAC) mechanism to
manage accesses to its resources. With the current architecture,
users' roles granted on each project and domain are stored into
Keystone, and can be updated through <a href="http://api.openstack.org/api-ref-identity.html#identity-v3">Keystone's API</a>. However,
policy enforcement (actually allowing or not the access to resources
according to a user's roles) is performed independently in each
service, based on the rules defined in each <code>policy.json</code> file.</p>
<p>In a default OpenStack setup (like Devstack), two roles are created:</p>
<ul>
<li>
<p>The <code>Member</code> role, which when granted to a user on a project, allows
  him to manage resources (instances, volumes, ...) in this project.</p>
</li>
<li>
<p>The <code>admin</code> role, which when granted to a user on any project,
  offers to this user a total control over the whole OpenStack
  platform. Although this is the current behavior, it has been <a href="https://bugs.launchpad.net/keystone/+bug/968696">marked
  as a bug</a>.</p>
</li>
</ul>
<p>However, the OpenStack policy engine allows operators to specify fine
grained set of rules to control access to resources of each OpenStack
service (Keystone, Nova, Cinder, ...).</p>
<h2>Attributes available to build custom policies</h2>
<p>Four types of attributes can be used to set policy rules:</p>
<ul>
<li>
<p>User roles, which can be checked by using the following syntax:</p>
<div class="highlight"><pre><span></span>role:&lt;requires_role&gt;
</pre></div>


</li>
<li>
<p>Other user related attributes (stored into or obtained through the
  token). The following attributes are available: user_id, domain_id
  or project_id (depending on the scope), and can be checked against
  constants or other attributes:</p>
<div class="highlight"><pre><span></span>project_id:&lt;some_attribute&gt;
</pre></div>


</li>
<li>
<p>API call attributes are any data sent along with the API call. They
  can be checked against constants or user attributes. For instance,
  the following statement checks that a user being created is in the
  same domain as his creator (note that API call attributes have to be
  on the right side of the expression, while user attributes are on
  the left side):</p>
<div class="highlight"><pre><span></span>domain_id:user.domain_id
</pre></div>


</li>
<li>
<p>The fourth category of attributes are what I'd call contextual
  attributes. These are the attributes of objects referenced (or
  targeted) by an API call; i.e. any object whose id appear somewhere
  in the API call. For instance, when granting a new role on a project
  to a user, all attributes related to the role, the project and the
  user are available to the policy engine, through the <code>target</code>
  keyword. The following syntax checks that the role of the context is
  the <code>Member</code> role:</p>
<div class="highlight"><pre><span></span>&#39;Member&#39;:target.role.name
</pre></div>


</li>
</ul>
<p>Depending on the type of API calls, some of the following attributes
will be available, according to the objects impacted by the action:</p>
<ul>
<li>
<p>domain:</p>
<ul>
<li>target.domain.enabled</li>
<li>target.domain.id</li>
<li>target.domain.name</li>
</ul>
</li>
<li>
<p>group:</p>
<ul>
<li>target.group.description</li>
<li>target.group.domain_id</li>
<li>target.group.id</li>
<li>target.group.name</li>
</ul>
</li>
<li>
<p>project:</p>
<ul>
<li>target.project.description</li>
<li>target.project.domain_id</li>
<li>target.project.enabled</li>
<li>target.project.id</li>
<li>target.project.name</li>
</ul>
</li>
<li>
<p>role:</p>
<ul>
<li>target.role.id</li>
<li>target.role.name</li>
</ul>
</li>
<li>
<p>user:</p>
<ul>
<li>target.user.default_project_id</li>
<li>target.user.description</li>
<li>target.user.domain_id</li>
<li>target.user.enabled</li>
<li>target.user.id</li>
<li>target.user.name</li>
</ul>
</li>
</ul>
<h2>Example: admin and super_admin</h2>
<p>The following example is taken from a User Story that we were
considering at <a href="http://www.cloudwatt.com">CloudWatt</a>. As a cloud service provider, we wanted
to be able to have 2 different levels of administrator roles:</p>
<ul>
<li>An <code>admin</code> role, which allows its users to grant the <code>Member</code> role
  to any other user.</li>
<li>While the <code>super_admin</code> role allows granting any role.</li>
</ul>
<p>When added to Keystone's ̀<code>policy.json</code> file, the following rules
implements the two roles described previously:</p>
<div class="highlight"><pre><span></span>&quot;admin_grant_member&quot;: &quot;role:admin and &#39;Member&#39;:%(target.role.name)s&quot;,
&quot;identity:create_grant&quot;: &quot;role:super_admin or rule:admin_grant_member&quot;,
</pre></div>


<p>The first rule describes a new rule called <code>admin_grant_member</code>, which
checks that the user authenticated by the token has the <code>admin</code> role
(on its scope), and that the role in the context (the role the admin
is trying to grant) is the <code>Member</code> role (we used the <code>name</code>
attribute, but could use the role's id instead).</p>
<p>The second rule is checked whenever an API call is made to grant a
role to a user (action <code>identity:create_grant</code>). This rule tells the
policy engine that in order for a user to be allowed to grant a role
to another user, the user authenticated by the token must either have
the <code>super_admin</code> role, or satisfy the <code>admin_grant_member</code> rule.</p>
<p>Put together these two rules actually meet the use case. Any user with
the <code>admin</code> role will only be able to grant the <code>Member</code> role to other
users, while users with the <code>super_admin</code> role will be able to grant
any role.</p>
<h2>Notes</h2>
<p>One of the most powerful rules that the OpenStack policy engine
allows, are those limiting a user's actions to his own domain or
project. These kind of rules are widely used in <a href="https://github.com/openstack/keystone/blob/master/etc/policy.v3cloudsample.json">Keystone's
policy.v3cloudsample.json</a>.</p>
<p>Also note, that a recent patch merged into oslo-incubator implements
the blueprint allowing the policy engine to <a href="https://blueprints.launchpad.net/oslo/+spec/policy-constant-check">check contextual
attributes against constant values</a>. This patch will have to be
synchronized into the OpenStack projects for them to benefit from this
feature.</p>
<!-- /content -->
      <footer>
        <p>Posted by <a href="http://www.florentflament.com/blog/author/florent-flament.html">Florent Flament</a> on <time datetime="2014-02-09T00:00:00+01:00">Sun 09 February 2014</time> in <a href="http://www.florentflament.com/blog/category/openstack.html">OpenStack</a>. Tags: <a href="http://www.florentflament.com/blog/tag/openstack.html">OpenStack</a>, <a href="http://www.florentflament.com/blog/tag/keystone.html">Keystone</a>, <a href="http://www.florentflament.com/blog/tag/policies.html">Policies</a>.</p>
      </footer>
    </article>
    <nav class="m-navpanel m-col-m-2">
      <h3>Categories</h3>
      <ol class="m-block-bar-m">
        <li><a href="http://www.florentflament.com/blog/category/misc.html">misc</a></li>
        <li><a href="http://www.florentflament.com/blog/category/openstack.html">OpenStack</a></li>
        <li><a href="http://www.florentflament.com/blog/category/thoughts.html">thoughts</a></li>
      </ol>
      <h3>Tag cloud</h3>
      <ul class="m-tagcloud">
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/amd.html">AMD</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/apple.html">Apple</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/arduino.html">Arduino</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/atmega.html">ATmega</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ay-3-8910.html">AY-3-8910</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/benchmark.html">Benchmark</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/bug.html">bug</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/ceph.html">Ceph</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/chef.html">Chef</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/cinder.html">Cinder</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/costs.html">Costs</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/cryptocurrency.html">Cryptocurrency</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-management.html">Data management</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-safety.html">Data Safety</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-security.html">Data Security</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/docker.html">Docker</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/documentation.html">Documentation</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/gf7050t-m5.html">GF7050T-M5</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/git.html">Git</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/gpu.html">GPU</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/hardware.html">Hardware</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/irc.html">IRC</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/jekyll.html">Jekyll</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/kernel.html">Kernel</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/keystone.html">Keystone</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/kvm.html">KVM</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/libvirt.html">libvirt</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/linux.html">Linux</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/mcss.html">m.css</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/microsft.html">Microsft</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/old-hardware.html">Old Hardware</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/opencl.html">OpenCL</a></li>
        <li class="m-tag-5"><a href="http://www.florentflament.com/blog/tag/openstack.html">OpenStack</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/operations.html">operations</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/pelican.html">Pelican</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/policies.html">Policies</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/printers.html">Printers</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/radeon.html">Radeon</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/raspberry-pi.html">Raspberry Pi</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/raspbian.html">Raspbian</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ring.html">Ring</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/rx-480.html">RX 480</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/sndh.html">SNDH</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ssh.html">SSH</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/swift.html">Swift</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ubuntu.html">Ubuntu</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/virtualization.html">Virtualization</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/vm.html">VM</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/website-generator.html">Website generator</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/windows.html">Windows</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ym2149.html">YM2149</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ym2149f.html">YM2149F</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/znc.html">ZNC</a></li>
      </ul>
    </nav>
  </div>
</div>
</main>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Florent Flament 2 cents. Powered by <a href="https://getpelican.com">Pelican</a> and <a href="https://mcss.mosra.cz">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>