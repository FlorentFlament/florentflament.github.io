<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>OpenStack Swift Ring made understandable</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Florent Flament">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Florent Flament's Tech Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Florent Flament's Tech Blog </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/misc.html">
						<i class="icon-folder-open icon-large"></i>misc
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/openstack.html">
						<i class="icon-folder-open icon-large"></i>OpenStack
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to OpenStack Swift Ring made understandable">
                                        OpenStack Swift Ring made understandable
                                </a>
<a href="http://twitter.com/share" class="twitter-share-button"
   data-count="horizontal" data-via="florentflament_">Tweet</a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-10-11T22:00:00+02:00">
        <i class="icon-calendar"></i>sam. 11 octobre 2014
</abbr>
<span class="label">By</span>
<a href="./author/florent-flament.html"><i class="icon-user"></i>Florent Flament</a>
<span class="label">Category</span>
<a href="./category/openstack.html"><i class="icon-folder-open"></i>OpenStack</a>.


<span class="label">Tags</span>
	<a href="./tag/openstack.html"><i class="icon-tag"></i>OpenStack</a>
	<a href="./tag/swift.html"><i class="icon-tag"></i>Swift</a>
	<a href="./tag/ring.html"><i class="icon-tag"></i>Ring</a>
</footer><!-- /.post-info -->                </div>
                <p>When people talk about OpenStack Swift, we often hear the word
Ring. This is because the Ring is a central piece in how Swift is
working. But what <em>is</em> this thing everyone's talking about ?</p>
<p>The Ring refers to 3 files that are shared among every Swift nodes
(storage and proxy nodes):</p>
<ul>
<li>object.ring.gz</li>
<li>container.ring.gz</li>
<li>account.ring.gz</li>
</ul>
<p>There is actually one ring per type of data manipulated by Swift:
Objects, Containers and Accounts. These files determine on which
physical devices (hard disks) will be stored each object (and also
each container and account). The number of devices on which an object
is stored depends on the number of replicas (copies) specified for the
Swift cluster.</p>
<h2>How does it concretely work</h2>
<p>When receiving an object to store, Swift computes a (MD5) hash of the
object's full name (including its account's and container's name). A
part of this hash is kept and interpreted by Swift as the partition
number. The length of the hash segment kept depends on the number of
partitions that has been set in the Swift cluster; This number is
necessarily a power of 2. So that if we keep n bits of the hash, we
have 2^n partitions.</p>
<p>The object ring is a map that associates each partition to a specific
physical device. This mechanism is then repeated for every object's
replicas, and also for containers and accounts.</p>
<p>To be more specific, the object's ring has 3 components:</p>
<ul>
<li>What is referred in the code as the <code>_replica2part2dev</code> table (which
  name is relatively explicit as we'll see later on)</li>
<li>The table of devices describing each device</li>
<li>The length of an object's hash to consider as the partition number</li>
</ul>
<p>The <code>_replica2part2dev</code> structure is a 2-dimensional table, so that
for any (replica number, partition number) couple, the table indicates
the physical device, where the object should be stored.</p>
<p>The devices table contains every information that a Swift node needs
in order to reach a given device; It consists mostly in the device's
storage node's IP address, the TCP port to use, and the physical
device name on the storage node.</p>
<p>In the end, the Ring is composed of 2 tables and one integer. If I
were to choose a name for such structure, I would call it the Table. I
couldn't find any explanation of why the name Ring was adopted, but my
guess is that some previous algorithm may have used some modular
computation, which people tend to represent using rings..</p>
<h2>Example</h2>
<p>Here is a simple example to make everything clear. Let's consider a
Swift cluster with 2 storage nodes, with the following IPs addresses:
<code>192.168.0.10</code> and <code>192.168.0.11</code>. Each storage node has two devices:
<code>sdb1</code> and <code>sdc1</code>.</p>
<p>An example of <code>_replica2part2dev</code> table with 3 replicas, 8 partitions
and 4 devices would be:</p>
<div class="highlight"><pre><span></span>r
e  |   +-----------------+
p  | 0 | 0 1 2 3 0 1 2 3 |
l  | 1 | 1 2 3 0 1 2 3 0 |
i  | 2 | 2 3 0 1 2 3 0 1 |
c  v   +-----------------+
a        0 1 2 3 4 5 6 7
       ------------------&amp;gt;
           partition
</pre></div>


<p>The table has 3 lines, one for each replica, and 8 columns, one for
each partition. To find the device storing the replica number 1 of
partition number 2, we select the line of index 1 and column of index
2. This lead us to the device ID 3.</p>
<p>The devices table is very similar to what we can obtain by using the
<code>swift-ring-builder</code> with only the builder file as argument:</p>
<div class="highlight"><pre><span></span>$ swift-ring-builder mybuilder 
mybuilder, build version <span class="m">4</span>
<span class="m">8</span> partitions, <span class="m">3</span>.000000 replicas, <span class="m">1</span> regions, <span class="m">1</span> zones, <span class="m">4</span> devices, <span class="m">0</span>.00 balance
The minimum number of hours before a partition can be reassigned is <span class="m">0</span>
Devices:    id  region  zone      ip address  port  replication ip  replication port      name weight partitions balance meta
             <span class="m">0</span>       <span class="m">1</span>     <span class="m">1</span>    <span class="m">192</span>.168.0.10  <span class="m">6000</span>    <span class="m">192</span>.168.0.10              <span class="m">6000</span>      sdb1 <span class="m">100</span>.00          <span class="m">6</span>    <span class="m">0</span>.00 
             <span class="m">1</span>       <span class="m">1</span>     <span class="m">1</span>    <span class="m">192</span>.168.0.10  <span class="m">6000</span>    <span class="m">192</span>.168.0.10              <span class="m">6000</span>      sdc1 <span class="m">100</span>.00          <span class="m">6</span>    <span class="m">0</span>.00 
             <span class="m">2</span>       <span class="m">1</span>     <span class="m">1</span>    <span class="m">192</span>.168.0.11  <span class="m">6000</span>    <span class="m">192</span>.168.0.11              <span class="m">6000</span>      sdb1 <span class="m">100</span>.00          <span class="m">6</span>    <span class="m">0</span>.00 
             <span class="m">3</span>       <span class="m">1</span>     <span class="m">1</span>    <span class="m">192</span>.168.0.11  <span class="m">6000</span>    <span class="m">192</span>.168.0.11              <span class="m">6000</span>      sdc1 <span class="m">100</span>.00          <span class="m">6</span>    <span class="m">0</span>.00
</pre></div>


<p>The device of ID 3 can be found on server 192.168.0.11, port 6000,
device name sdc1.</p>
<h2>Simple is good</h2>
<p>What I like with such mechanism is that the smartness of the data
placement is performed by the <code>swift-ring-builder</code>, a standalone tool
provided with Swift. Once the rings have been built, Swift processes
running on the Swift nodes have a fully deterministic and easily
predictable behavior.</p>
<p>The <code>swift-ring-builder</code> manipulates <code>builders</code> files; these are files
containing architectural information about the Swift cluster (like
distribution of devices and nodes among regions and zones). These
<code>builders</code> are then used to generate the <code>rings</code> files. As with the
rings, there is one builder per type of data (objects, containers and
accounts).</p>
<p>Thanks to this mechanism the complexity of smartly storing objects has
been well separated between:</p>
<ul>
<li>
<p>Smartly assigning partitions (and corresponding objects, containers
  and accounts) to devices, taking into account the cluster's
  architecture. This is performed by the <code>swift-ring-builder</code></p>
</li>
<li>
<p>Ensuring that files are stored uncorrupted at the appropriate
  locations; This is performer by the processes running on the Swift
  nodes.</p>
</li>
</ul>
<h2>More</h2>
<p>For more information about the ring, one can read the <a href="http://docs.openstack.org/developer/swift/overview_ring.html">Swift's
developer documentation about the Ring</a>.</p>
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "openstack-swift-ring-made-understandable.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://florentflament.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://blog.chmouel.com/"><i class="icon-external-link"></i>Chmouel's Blog</a></li>
    <li><a href="http://dachary.org/"><i class="icon-external-link"></i>Lo√Øc Dachary's Blog</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/misc.html">
    <i class="icon-folder-open icon-large"></i>misc
</a>
</li>
<li>
<a href="./category/openstack.html">
    <i class="icon-folder-open icon-large"></i>OpenStack
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-4">
    <a href="./tag/amd.html">
        <i class="icon-tag icon-large"></i>AMD
    </a>
</li>
<li class="tag-4">
    <a href="./tag/atmega.html">
        <i class="icon-tag icon-large"></i>ATmega
    </a>
</li>
<li class="tag-2">
    <a href="./tag/ay-3-8910.html">
        <i class="icon-tag icon-large"></i>AY-3-8910
    </a>
</li>
<li class="tag-4">
    <a href="./tag/apple.html">
        <i class="icon-tag icon-large"></i>Apple
    </a>
</li>
<li class="tag-1">
    <a href="./tag/arduino.html">
        <i class="icon-tag icon-large"></i>Arduino
    </a>
</li>
<li class="tag-4">
    <a href="./tag/benchmark.html">
        <i class="icon-tag icon-large"></i>Benchmark
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ceph.html">
        <i class="icon-tag icon-large"></i>Ceph
    </a>
</li>
<li class="tag-4">
    <a href="./tag/chef.html">
        <i class="icon-tag icon-large"></i>Chef
    </a>
</li>
<li class="tag-2">
    <a href="./tag/cinder.html">
        <i class="icon-tag icon-large"></i>Cinder
    </a>
</li>
<li class="tag-2">
    <a href="./tag/costs.html">
        <i class="icon-tag icon-large"></i>Costs
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-safety.html">
        <i class="icon-tag icon-large"></i>Data Safety
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-security.html">
        <i class="icon-tag icon-large"></i>Data Security
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-management.html">
        <i class="icon-tag icon-large"></i>Data management
    </a>
</li>
<li class="tag-2">
    <a href="./tag/docker.html">
        <i class="icon-tag icon-large"></i>Docker
    </a>
</li>
<li class="tag-4">
    <a href="./tag/documentation.html">
        <i class="icon-tag icon-large"></i>Documentation
    </a>
</li>
<li class="tag-4">
    <a href="./tag/gpu.html">
        <i class="icon-tag icon-large"></i>GPU
    </a>
</li>
<li class="tag-4">
    <a href="./tag/git.html">
        <i class="icon-tag icon-large"></i>Git
    </a>
</li>
<li class="tag-4">
    <a href="./tag/hardware.html">
        <i class="icon-tag icon-large"></i>Hardware
    </a>
</li>
<li class="tag-4">
    <a href="./tag/irc.html">
        <i class="icon-tag icon-large"></i>IRC
    </a>
</li>
<li class="tag-4">
    <a href="./tag/kvm.html">
        <i class="icon-tag icon-large"></i>KVM
    </a>
</li>
<li class="tag-2">
    <a href="./tag/kernel.html">
        <i class="icon-tag icon-large"></i>Kernel
    </a>
</li>
<li class="tag-2">
    <a href="./tag/keystone.html">
        <i class="icon-tag icon-large"></i>Keystone
    </a>
</li>
<li class="tag-2">
    <a href="./tag/linux.html">
        <i class="icon-tag icon-large"></i>Linux
    </a>
</li>
<li class="tag-4">
    <a href="./tag/microsft.html">
        <i class="icon-tag icon-large"></i>Microsft
    </a>
</li>
<li class="tag-4">
    <a href="./tag/opencl.html">
        <i class="icon-tag icon-large"></i>OpenCL
    </a>
</li>
<li class="tag-1">
    <a href="./tag/openstack.html">
        <i class="icon-tag icon-large"></i>OpenStack
    </a>
</li>
<li class="tag-4">
    <a href="./tag/policies.html">
        <i class="icon-tag icon-large"></i>Policies
    </a>
</li>
<li class="tag-4">
    <a href="./tag/printers.html">
        <i class="icon-tag icon-large"></i>Printers
    </a>
</li>
<li class="tag-4">
    <a href="./tag/rx-480.html">
        <i class="icon-tag icon-large"></i>RX 480
    </a>
</li>
<li class="tag-4">
    <a href="./tag/radeon.html">
        <i class="icon-tag icon-large"></i>Radeon
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspberry-pi.html">
        <i class="icon-tag icon-large"></i>Raspberry Pi
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspbian.html">
        <i class="icon-tag icon-large"></i>Raspbian
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ring.html">
        <i class="icon-tag icon-large"></i>Ring
    </a>
</li>
<li class="tag-4">
    <a href="./tag/sndh.html">
        <i class="icon-tag icon-large"></i>SNDH
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ssh.html">
        <i class="icon-tag icon-large"></i>SSH
    </a>
</li>
<li class="tag-2">
    <a href="./tag/swift.html">
        <i class="icon-tag icon-large"></i>Swift
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ubuntu.html">
        <i class="icon-tag icon-large"></i>Ubuntu
    </a>
</li>
<li class="tag-4">
    <a href="./tag/vm.html">
        <i class="icon-tag icon-large"></i>VM
    </a>
</li>
<li class="tag-4">
    <a href="./tag/virtualization.html">
        <i class="icon-tag icon-large"></i>Virtualization
    </a>
</li>
<li class="tag-4">
    <a href="./tag/windows.html">
        <i class="icon-tag icon-large"></i>Windows
    </a>
</li>
<li class="tag-2">
    <a href="./tag/ym2149.html">
        <i class="icon-tag icon-large"></i>YM2149
    </a>
</li>
<li class="tag-2">
    <a href="./tag/ym2149f.html">
        <i class="icon-tag icon-large"></i>YM2149F
    </a>
</li>
<li class="tag-4">
    <a href="./tag/znc.html">
        <i class="icon-tag icon-large"></i>ZNC
    </a>
</li>
<li class="tag-4">
    <a href="./tag/bug.html">
        <i class="icon-tag icon-large"></i>bug
    </a>
</li>
<li class="tag-4">
    <a href="./tag/libvirt.html">
        <i class="icon-tag icon-large"></i>libvirt
    </a>
</li>
<li class="tag-4">
    <a href="./tag/operations.html">
        <i class="icon-tag icon-large"></i>operations
    </a>
</li>

<li class="nav-header">
<a href="https://twitter.com/florentflament_" class="twitter-follow-button" data-show-count="false">Follow @florentflament_</a>
</li>
<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
        </address><!-- /#about -->
        <p>Powered by <a href="http://blog.getpelican.com/">Pelican<i class="icon-external-link"></i></a></p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-23791515-4");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'florentflament';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>