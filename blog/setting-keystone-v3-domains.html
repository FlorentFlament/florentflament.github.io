<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8" />
  <title>Setting Keystone v3 domains | Florent Flament 2 cents</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="http://www.florentflament.com/blog/static/m-dark.css" />
  <link rel="canonical" href="http://www.florentflament.com/blog/setting-keystone-v3-domains.html" />
  <link href="http://www.florentflament.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Florent Flament 2 cents" />
  <link href="http://www.florentflament.com/blog/feeds/openstack.atom.xml" type="application/atom+xml" rel="alternate" title="Florent Flament 2 cents | OpenStack" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
  <meta property="og:site_name" content="Florent Flament 2 cents" />
  <meta property="og:title" content="Setting Keystone v3 domains" />
  <meta name="twitter:title" content="Setting Keystone v3 domains" />
  <meta property="og:url" content="http://www.florentflament.com/blog/setting-keystone-v3-domains.html" />
  <meta property="og:description" content="The Openstack Identity v3 API, provided by Keystone, offers features that were lacking in the previous version. Among these features, it introduces the concept of domains, allowing isolation of projects and users. For instance, an administrator allowed to create projects and users in a given domain, may not have any …" />
  <meta name="twitter:description" content="The Openstack Identity v3 API, provided by Keystone, offers features that were lacking in the previous version. Among these features, it introduces the concept of domains, allowing isolation of projects and users. For instance, an administrator allowed to create projects and users in a given domain, may not have any …" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:type" content="article" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="http://www.florentflament.com/blog/" id="m-navbar-brand" class="m-col-t-9 m-col-m-none m-left-m">Florent Flament 2 cents</a>
    </div>
  </div>
</nav></header>
<main>
<div class="m-container">
  <div class="m-row">
    <article class="m-col-m-10 m-nopadb">
      <header>
        <h1><a href="http://www.florentflament.com/blog/setting-keystone-v3-domains.html" rel="bookmark" title="Permalink to Setting Keystone v3 domains">
          <time class="m-date" datetime="2014-01-18T00:00:00+01:00">
            Jan <span class="m-date-day">18</span> 2014
          </time>
          Setting Keystone v3 domains
        </a></h1>
      </header>
      <div class="m-clearfix-l"></div>
<!-- content -->
<p>The <a href="http://api.openstack.org/api-ref-identity.html#identity-v3">Openstack Identity v3 API</a>, provided by Keystone, offers
features that were lacking in the previous version. Among these
features, it introduces the concept of domains, allowing isolation of
projects and users. For instance, an administrator allowed to create
projects and users in a given domain, may not have any right in
another one. While these features look very exciting, some
configuration needs to be done to have a working identity v3 service
with domains properly set.</p>
<p><a href="http://docs.openstack.org/developer/keystone/configuration.html#keystone-api-protection-with-role-based-access-control-rbac">Keystone API protection</a> section of the developer's doc provides
hints about how to set-up a multi-domain installation. Starting from
there, I describe the full steps to have a multi-domain setup running,
by using <code>curl</code> to send http requests and <code>jq</code> to parse the json
answers.</p>
<h2>Setting an admin domain and a cloud admin</h2>
<p>First, we have to start on a fresh non multi-domain installation with
the <a href="https://github.com/openstack/keystone/blob/master/etc/policy.json">default policy file</a>.</p>
<ul>
<li>
<p>With the <code>admin</code> user we can create the <code>admin_domain</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ADMIN_TOKEN</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/auth/tokens <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;auth&quot;: {</span>
<span class="s1">        &quot;identity&quot;: {</span>
<span class="s1">            &quot;methods&quot;: [</span>
<span class="s1">                &quot;password&quot;</span>
<span class="s1">            ],</span>
<span class="s1">            &quot;password&quot;: {</span>
<span class="s1">                &quot;user&quot;: {</span>
<span class="s1">                    &quot;domain&quot;: {</span>
<span class="s1">                        &quot;name&quot;: &quot;Default&quot;</span>
<span class="s1">                    },</span>
<span class="s1">                    &quot;name&quot;: &quot;admin&quot;,</span>
<span class="s1">                    &quot;password&quot;: &quot;password&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        },</span>
<span class="s1">        &quot;scope&quot;: {</span>
<span class="s1">            &quot;project&quot;: {</span>
<span class="s1">                &quot;domain&quot;: {</span>
<span class="s1">                    &quot;name&quot;: &quot;Default&quot;</span>
<span class="s1">                },</span>
<span class="s1">                &quot;name&quot;: &quot;admin&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> grep ^X-Subject-Token: <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="k">)</span>

<span class="nv">ID_ADMIN_DOMAIN</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/domains <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;domain&quot;: {</span>
<span class="s1">    &quot;enabled&quot;: true,</span>
<span class="s1">    &quot;name&quot;: &quot;admin_domain&quot;</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> jq .domain.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of domain cloud: </span><span class="nv">$ID_ADMIN_DOMAIN</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>Then we can create our <code>cloud_admin</code> user, within the <code>admin_domain</code>
  domain.</p>
<div class="highlight"><pre><span></span><span class="nv">ID_CLOUD_ADMIN</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/users <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s2">&quot;</span>
<span class="s2">{</span>
<span class="s2">    \&quot;user\&quot;: {</span>
<span class="s2">        \&quot;description\&quot;: \&quot;Cloud administrator\&quot;,</span>
<span class="s2">        \&quot;domain_id\&quot;: \&quot;</span><span class="nv">$ID_ADMIN_DOMAIN</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;enabled\&quot;: true,</span>
<span class="s2">        \&quot;name\&quot;: \&quot;cloud_admin\&quot;,</span>
<span class="s2">        \&quot;password\&quot;: \&quot;password\&quot;</span>
<span class="s2">    }</span>
<span class="s2">}&quot;</span> <span class="p">|</span> jq .user.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of user cloud_admin: </span><span class="nv">$ID_CLOUD_ADMIN</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>And we grant to our user <code>cloud_admin</code> the <code>admin</code> role on domain
  <code>admin_domain</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ADMIN_ROLE_ID</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/roles?name<span class="o">=</span>admin <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="p">|</span> jq .roles<span class="o">[</span><span class="m">0</span><span class="o">]</span>.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

curl -X PUT http://localhost:5000/v3/domains/<span class="si">${</span><span class="nv">ID_ADMIN_DOMAIN</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_CLOUD_ADMIN</span><span class="si">}</span>/roles/<span class="si">${</span><span class="nv">ADMIN_ROLE_ID</span><span class="si">}</span> <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span>

curl http://localhost:5000/v3/domains/<span class="si">${</span><span class="nv">ID_ADMIN_DOMAIN</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_CLOUD_ADMIN</span><span class="si">}</span>/roles<span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="p">|</span> jq .roles
</pre></div>


</li>
<li>
<p>Once the <code>admin_domain</code> has been created with its <code>cloud_admin</code>
  user, we can enforce a domain based policy. In order to do that, we
  have to copy the <a href="https://github.com/openstack/keystone/blob/master/etc/policy.v3cloudsample.json">policy.v3cloudsample.json</a> file over our former
  <code>/etc/keystone/policy.json</code>, while replacing the string
  <code>admin_domain_id</code> by the ID of the <code>admin_domain</code> we just
  created. Locate the <code>policy.v3cloudsample.json</code> file into the <code>etc</code>
  directory of Keystone's source.</p>
<div class="highlight"><pre><span></span>sed s/admin_domain_id/<span class="si">${</span><span class="nv">ID_ADMIN_DOMAIN</span><span class="si">}</span>/ <span class="se">\</span>
    &lt; policy.v3cloudsample.json <span class="se">\</span>
    &gt; /etc/keystone/policy.json
</pre></div>


</li>
</ul>
<p>Warning, current version (commit
19620076f587f925c5d2fa59780c1a80dde15db2) of policy.v3cloudsample.json
doesn't allow <code>cloud_admin</code> to manage users in other domains than its
own (see <a href="https://bugs.launchpad.net/keystone/+bug/1267187">bug 1267187</a>). Until the patch is merged, I suggest using
this <a href="https://review.openstack.org/#/c/65510/">policy.c3cloudsample.json under review</a>.</p>
<h2>Creating domains and admins</h2>
<p>From now on, the <code>admin</code> user can only manage projects and users in
the <code>Default</code> domain. To create other domains we will have to
authenticate with the <code>cloud_admin</code> user created above.</p>
<ul>
<li>
<p>Getting a token scoped on the <code>admin_domain</code>, for user <code>cloud_admin</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">CLOUD_ADMIN_TOKEN</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/auth/tokens <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;auth&quot;: {</span>
<span class="s1">        &quot;identity&quot;: {</span>
<span class="s1">            &quot;methods&quot;: [</span>
<span class="s1">                &quot;password&quot;</span>
<span class="s1">            ],</span>
<span class="s1">            &quot;password&quot;: {</span>
<span class="s1">                &quot;user&quot;: {</span>
<span class="s1">                    &quot;domain&quot;: {</span>
<span class="s1">                        &quot;name&quot;: &quot;admin_domain&quot;</span>
<span class="s1">                    },</span>
<span class="s1">                    &quot;name&quot;: &quot;cloud_admin&quot;,</span>
<span class="s1">                    &quot;password&quot;: &quot;password&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        },</span>
<span class="s1">        &quot;scope&quot;: {</span>
<span class="s1">            &quot;domain&quot;: {</span>
<span class="s1">                &quot;name&quot;: &quot;admin_domain&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> grep ^X-Subject-Token: <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="k">)</span>
</pre></div>


</li>
<li>
<p>Creating domains <code>dom1</code> and <code>dom2</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ID_DOM1</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/domains <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$CLOUD_ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;domain&quot;: {</span>
<span class="s1">        &quot;enabled&quot;: true,</span>
<span class="s1">        &quot;name&quot;: &quot;dom1&quot;</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> jq .domain.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span><span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of dom1: </span><span class="nv">$ID_DOM1</span><span class="s2">&quot;</span>

<span class="nv">ID_DOM2</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/domains <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$CLOUD_ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;domain&quot;: {</span>
<span class="s1">        &quot;enabled&quot;: true,</span>
<span class="s1">        &quot;name&quot;: &quot;dom2&quot;</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> jq .domain.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span><span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of dom2: </span><span class="nv">$ID_DOM2</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>Now we will create a user <code>adm1</code> in domain <code>dom1</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ID_ADM1</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/users <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$CLOUD_ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s2">&quot;</span>
<span class="s2">{</span>
<span class="s2">    \&quot;user\&quot;: {</span>
<span class="s2">        \&quot;description\&quot;: \&quot;Administrator of domain dom1\&quot;,</span>
<span class="s2">        \&quot;domain_id\&quot;: \&quot;</span><span class="nv">$ID_DOM1</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;enabled\&quot;: true,</span>
<span class="s2">        \&quot;name\&quot;: \&quot;adm1\&quot;,</span>
<span class="s2">        \&quot;password\&quot;: \&quot;password\&quot;</span>
<span class="s2">    }</span>
<span class="s2">}&quot;</span> <span class="p">|</span> jq .user.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span><span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of user adm1: </span><span class="nv">$ID_ADM1</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>We will also grant the <code>admin</code> role on domain <code>dom1</code> to this <code>adm1</code>
  user.</p>
<div class="highlight"><pre><span></span>curl -X PUT http://localhost:5000/v3/domains/<span class="si">${</span><span class="nv">ID_DOM1</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_ADM1</span><span class="si">}</span>/roles/<span class="si">${</span><span class="nv">ADMIN_ROLE_ID</span><span class="si">}</span> <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$CLOUD_ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span>

curl http://localhost:5000/v3/domains/<span class="si">${</span><span class="nv">ID_DOM1</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_ADM1</span><span class="si">}</span>/roles <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$CLOUD_ADMIN_TOKEN</span><span class="s2">&quot;</span> <span class="p">|</span> jq .roles
</pre></div>


</li>
</ul>
<h2>Creating projects and users</h2>
<p>The <code>adm1</code> user can now fully manage domain <code>dom1</code>. He is allowed to
manage as many projects and users as he wishes within <code>dom1</code>, while
not being able to access resources of domain <code>dom2</code>.</p>
<ul>
<li>
<p>Now we authenticate as user <code>adm1</code> with a scope on <code>dom1</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ADM1_TOKEN</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/auth/tokens <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;auth&quot;: {</span>
<span class="s1">        &quot;identity&quot;: {</span>
<span class="s1">            &quot;methods&quot;: [</span>
<span class="s1">                &quot;password&quot;</span>
<span class="s1">            ],</span>
<span class="s1">            &quot;password&quot;: {</span>
<span class="s1">                &quot;user&quot;: {</span>
<span class="s1">                    &quot;domain&quot;: {</span>
<span class="s1">                        &quot;name&quot;: &quot;dom1&quot;</span>
<span class="s1">                    },</span>
<span class="s1">                    &quot;name&quot;: &quot;adm1&quot;,</span>
<span class="s1">                    &quot;password&quot;: &quot;password&quot;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        },</span>
<span class="s1">        &quot;scope&quot;: {</span>
<span class="s1">            &quot;domain&quot;: {</span>
<span class="s1">                &quot;name&quot;: &quot;dom1&quot;</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span> <span class="p">|</span> grep ^X-Subject-Token: <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="k">)</span>
</pre></div>


</li>
<li>
<p>We create a project <code>prj1</code> in domain <code>dom1</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ID_PRJ1</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/projects <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s2">&quot;</span>
<span class="s2">{</span>
<span class="s2">    \&quot;project\&quot;: {</span>
<span class="s2">        \&quot;enabled\&quot;: true,</span>
<span class="s2">        \&quot;domain_id\&quot;: \&quot;</span><span class="nv">$ID_DOM1</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;name\&quot;: \&quot;prj1\&quot;</span>
<span class="s2">    }\</span>
<span class="s2">}&quot;</span> <span class="p">|</span> jq .project.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of prj1: </span><span class="nv">$ID_PRJ1</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>When trying and creating a project in domain <code>dom2</code>, it fails.</p>
<div class="highlight"><pre><span></span>curl http://localhost:5000/v3/projects <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s2">&quot;</span>
<span class="s2">{</span>
<span class="s2">    \&quot;project\&quot;: {</span>
<span class="s2">        \&quot;enabled\&quot;: true,</span>
<span class="s2">        \&quot;domain_id\&quot;: \&quot;</span><span class="nv">$ID_DOM2</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;name\&quot;: \&quot;prj2\&quot;</span>
<span class="s2">    }\</span>
<span class="s2">}&quot;</span> <span class="p">|</span> jq .
</pre></div>


</li>
<li>
<p>Creating a standard user <code>usr1</code> in domain <code>dom1</code>, with default project <code>prj1</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">ID_USR1</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/users <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    -d <span class="s2">&quot;</span>
<span class="s2">{</span>
<span class="s2">    \&quot;user\&quot;: {</span>
<span class="s2">        \&quot;default_project_id\&quot;: \&quot;</span><span class="nv">$ID_PRJ1</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;description\&quot;: \&quot;Just a user of dom1\&quot;,</span>
<span class="s2">        \&quot;domain_id\&quot;: \&quot;</span><span class="nv">$ID_DOM1</span><span class="s2">\&quot;,</span>
<span class="s2">        \&quot;enabled\&quot;: true,</span>
<span class="s2">        \&quot;name\&quot;: \&quot;usr1\&quot;,</span>
<span class="s2">        \&quot;password\&quot;: \&quot;password\&quot;</span>
<span class="s2">    }</span>
<span class="s2">}&quot;</span> <span class="p">|</span> jq .user.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;ID of user usr1: </span><span class="nv">$ID_USR1</span><span class="s2">&quot;</span>
</pre></div>


</li>
<li>
<p>Granting <code>Member</code> role to user <code>usr1</code> on project <code>prj1</code>.</p>
<div class="highlight"><pre><span></span><span class="nv">MEMBER_ROLE_ID</span><span class="o">=</span><span class="k">$(</span><span class="se">\</span>
curl http://localhost:5000/v3/roles?name<span class="o">=</span>Member <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="p">|</span> jq .roles<span class="o">[</span><span class="m">0</span><span class="o">]</span>.id <span class="p">|</span> tr -d <span class="s1">&#39;&quot;&#39;</span> <span class="k">)</span>

curl -X PUT http://localhost:5000/v3/projects/<span class="si">${</span><span class="nv">ID_PRJ1</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_USR1</span><span class="si">}</span>/roles/<span class="si">${</span><span class="nv">MEMBER_ROLE_ID</span><span class="si">}</span> <span class="se">\</span>
    -s <span class="se">\</span>
    -i <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span>

curl http://localhost:5000/v3/projects/<span class="si">${</span><span class="nv">ID_PRJ1</span><span class="si">}</span>/users/<span class="si">${</span><span class="nv">ID_USR1</span><span class="si">}</span>/roles <span class="se">\</span>
    -s <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Token: </span><span class="nv">$ADM1_TOKEN</span><span class="s2">&quot;</span> <span class="p">|</span> jq .roles
</pre></div>


</li>
</ul>
<p>The domain administrator <code>adm1</code> ended up creating a project <code>prj1</code> and
a user <code>usr1</code> member of the project. <code>usr1</code> can now get a token scoped
on <code>prj1</code> and manage resources into this project.</p>
<!-- /content -->
      <footer>
        <p>Posted by <a href="http://www.florentflament.com/blog/author/florent-flament.html">Florent Flament</a> on <time datetime="2014-01-18T00:00:00+01:00">Sat 18 January 2014</time> in <a href="http://www.florentflament.com/blog/category/openstack.html">OpenStack</a>. Tags: <a href="http://www.florentflament.com/blog/tag/openstack.html">OpenStack</a>, <a href="http://www.florentflament.com/blog/tag/keystone.html">Keystone</a>.</p>
      </footer>
    </article>
    <nav class="m-navpanel m-col-m-2">
      <h3>Categories</h3>
      <ol class="m-block-bar-m">
        <li><a href="http://www.florentflament.com/blog/category/misc.html">misc</a></li>
        <li><a href="http://www.florentflament.com/blog/category/openstack.html">OpenStack</a></li>
      </ol>
      <h3>Tag cloud</h3>
      <ul class="m-tagcloud">
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/amd.html">AMD</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/apple.html">Apple</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/arduino.html">Arduino</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/atmega.html">ATmega</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ay-3-8910.html">AY-3-8910</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/benchmark.html">Benchmark</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/bug.html">bug</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/ceph.html">Ceph</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/chef.html">Chef</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/cinder.html">Cinder</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/costs.html">Costs</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/cryptocurrency.html">Cryptocurrency</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-management.html">Data management</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-safety.html">Data Safety</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/data-security.html">Data Security</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/docker.html">Docker</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/documentation.html">Documentation</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/gf7050t-m5.html">GF7050T-M5</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/git.html">Git</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/gpu.html">GPU</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/hardware.html">Hardware</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/irc.html">IRC</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/kernel.html">Kernel</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/keystone.html">Keystone</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/kvm.html">KVM</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/libvirt.html">libvirt</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/linux.html">Linux</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/microsft.html">Microsft</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/old-hardware.html">Old Hardware</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/opencl.html">OpenCL</a></li>
        <li class="m-tag-5"><a href="http://www.florentflament.com/blog/tag/openstack.html">OpenStack</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/operations.html">operations</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/policies.html">Policies</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/printers.html">Printers</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/radeon.html">Radeon</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/raspberry-pi.html">Raspberry Pi</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/raspbian.html">Raspbian</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ring.html">Ring</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/rx-480.html">RX 480</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/sndh.html">SNDH</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ssh.html">SSH</a></li>
        <li class="m-tag-2"><a href="http://www.florentflament.com/blog/tag/swift.html">Swift</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/ubuntu.html">Ubuntu</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/virtualization.html">Virtualization</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/vm.html">VM</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/windows.html">Windows</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ym2149.html">YM2149</a></li>
        <li class="m-tag-3"><a href="http://www.florentflament.com/blog/tag/ym2149f.html">YM2149F</a></li>
        <li class="m-tag-1"><a href="http://www.florentflament.com/blog/tag/znc.html">ZNC</a></li>
      </ul>
    </nav>
  </div>
</div>
</main>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Florent Flament 2 cents. Powered by <a href="https://getpelican.com">Pelican</a> and <a href="https://mcss.mosra.cz">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>