<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Splitting Swift cluster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Florent Flament">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Florent Flament's Tech Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Florent Flament's Tech Blog </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/misc.html">
						<i class="icon-folder-open icon-large"></i>misc
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/openstack.html">
						<i class="icon-folder-open icon-large"></i>OpenStack
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Splitting Swift cluster">
                                        Splitting Swift cluster
                                </a>
<a href="http://twitter.com/share" class="twitter-share-button"
   data-count="horizontal" data-via="florentflament_">Tweet</a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-10-20T23:25:00+02:00">
        <i class="icon-calendar"></i>Mon 20 October 2014
</abbr>
<span class="label">By</span>
<a href="./author/florent-flament.html"><i class="icon-user"></i>Florent Flament</a>
<span class="label">Category</span>
<a href="./category/openstack.html"><i class="icon-folder-open"></i>OpenStack</a>.


<span class="label">Tags</span>
	<a href="./tag/openstack.html"><i class="icon-tag"></i>OpenStack</a>
	<a href="./tag/swift.html"><i class="icon-tag"></i>Swift</a>
	<a href="./tag/operations.html"><i class="icon-tag"></i>operations</a>
</footer><!-- /.post-info -->                </div>
                <p>At <a href="https://www.cloudwatt.com/en/">Cloudwatt</a>, we have been operating a near hundred nodes Swift
cluster in a unique datacenter for a few years. The decision to split
the cluster on two datacenters has been taken recently. The goal is to
have at least one replica of each object on each site in order to
avoid data loss in case of the destruction of a full datacenter (fire,
plane crash, ...).</p>
<h2>Constraints when updating a running cluster</h2>
<p>Some precautions have to be taken when updating a running cluster with
customers' data. We want to ensure that no data is lost or corrupted
during the operation and that the cluster's performance isn't hurt too
badly. </p>
<p>In order to ensure that no data is lost, we have to follow some
guidelines including:</p>
<ul>
<li>Never move more that 1 replica of any object at any given step; That
  way we ensure that 2 copies out 3 are left intact in case something
  goes wrong.</li>
<li>Process by small steps to limit the impact in case of failure.</li>
<li>Check during each step that there is no unusual data corruptions,
  and that corrupted data are correctly handled and fixed.</li>
<li>Check after each step that data has been moved (or kept) at the
  correct place.</li>
<li>If any issue were to happen, rollback to previous step.</li>
</ul>
<p>To limit the impact on cluster's performance, we have to address to
following issues:</p>
<ul>
<li>Assess the availability of cluster resources (network bandwidth,
  storage nodes' disks &amp; CPU availability) at different times of day
  and week. This would allow to choose the best time to perform our
  steps.</li>
<li>Assess the load on the cluster of the steps planned to split the
  cluster.</li>
<li>Choose steps small enough so that:<ul>
<li>it fits time frames where cluster's resources are more available;</li>
<li>the load incurred by the cluster (and its users) is acceptable.</li>
</ul>
</li>
</ul>
<p>A number of these requirements have been addressed by Swift for a while:</p>
<ul>
<li>When updating Swift ring files, the <code>swift-ring-builder</code> tool
  doesn't move more than 1 replica during reassignment of cluster's
  partitions (unless something really went wrong). By performing only
  one reassignment per process step, we ensure that we don't move more
  than 1 replica at each step.</li>
<li>Checking for data corruption is made easy by Swift. 3 processes
  (<code>swift-object-auditor</code>, <code>swift-container-auditor</code> and
  <code>swift-account-auditor</code>) running on storage nodes are continuously
  checking and fixing data integrity.</li>
<li>Checking that data is at the correct location is also made easy by
  the <code>swift-dispersion-report</code> provided.</li>
<li>Updating the location of data is made seamless by updating and
  copying the Ring files to every Swift nodes. Once updated, the Ring
  files are loaded by Swift processes without the need of being
  restarted. Rollbacking data location is easily performed by
  replacing the new Ring files by previous ones.</li>
</ul>
<p>However, being able to control the amount of data to move to a new
datacenter at a given step is a brand new feature, that has been fixed
in <a href="https://github.com/openstack/swift/releases/tag/2.2.0">version 2.2.0 of Swift</a>, released on October 4th of 2014.</p>
<h2>Checking data integrity</h2>
<p>Swift <code>auditor</code> processes (<code>swift-object-auditor</code>,
<code>swift-container-auditor</code> and <code>swift-account-auditor</code>) running on
storage nodes are continuously checking data integrity, by checking
files' checksums. When a corrupted file is found, it is <em>quarantined</em>;
the data is removed from the node and the <em>replication</em> mechanism
takes care of replacing the missing data. Below is an example of what
concretely happens when manually corrupting an object.</p>
<p>Let's corrupt data by hand:</p>
<div class="highlight"><pre><span></span>root@swnode0:/srv/node/d1/objects/154808/c3a# cat 972e359caf9df6fdd3b8e295afd4cc3a/1410353767.57579.data
blabla
root@swnode0:/srv/node/d1/objects/154808/c3a# <span class="nb">echo</span> blablb &gt; 972e359caf9df6fdd3b8e295afd4cc3a/1410353767.57579.data
</pre></div>


<p>The corrupted object is 'quarantined' by the object-auditor when it
checks the files integrity. Here's how it appears in the
<code>/var/log/syslog</code> log file:</p>
<div class="highlight"><pre><span></span>Sep 10 13:56:44 swnode0 object-auditor: Quarantined object /srv/node/d1/objects/154808/c3a/972e359caf9df6fdd3b8e295afd4cc3a/1410353767.57579.data: ETag 9b36b2e89df94bc458d629499d38cf86 and file&#39;s md5 6235440677e53f66877f0c1fec6a89bd do not match
Sep 10 13:56:44 swnode0 object-auditor: ERROR Object /srv/node/d1/objects/154808/c3a/972e359caf9df6fdd3b8e295afd4cc3a failed audit and was quarantined: ETag 9b36b2e89df94bc458d629499d38cf86 and file&#39;s md5 6235440677e53f66877f0c1fec6a89bd do not match
Sep 10 13:56:44 swnode0 object-auditor: Object audit (ALL) &quot;forever&quot; mode completed: 0.02s. Total quarantined: 1, Total errors: 0, Total files/sec: 46.71, Total bytes/sec: 326.94, Auditing time: 0.02, Rate: 0.98
</pre></div>


<p>The quarantined object is then overwritten by the object-replicator of
a node that has the appropriate replica uncorrupted. Below is an
extract of the log file on such node:</p>
<div class="highlight"><pre><span></span>Sep 10 13:57:01 swnode1 object-replicator: Starting object replication pass.
Sep 10 13:57:01 swnode1 object-replicator: &lt;f+++++++++ c3a/972e359caf9df6fdd3b8e295afd4cc3a/1410353767.57579.data
Sep 10 13:57:01 swnode1 object-replicator: Successful rsync of /srv/node/d1/objects/154808/c3a at 192.168.100.10::object/d1/objects/154808 (0.182)
Sep 10 13:57:01 swnode1 object-replicator: 1/1 (100.00%) partitions replicated in 0.21s (4.84/sec, 0s remaining)
Sep 10 13:57:01 swnode1 object-replicator: 1 suffixes checked - 0.00% hashed, 100.00% synced
Sep 10 13:57:01 swnode1 object-replicator: Partition times: max 0.2050s, min 0.2050s, med 0.2050s
Sep 10 13:57:01 swnode1 object-replicator: Object replication complete. (0.00 minutes)
</pre></div>


<p>The corrupted data has been replaced by the correct data on the
initial storage node (where the file had been corrupted):</p>
<div class="highlight"><pre><span></span>root@swnode0:/srv/node/d1/objects/154808/c3a# cat 972e359caf9df6fdd3b8e295afd4cc3a/1410353767.57579.data
blabla
</pre></div>


<h2>Checking data location</h2>
<h3>Preparation</h3>
<p>We can use the <code>swift-dispersion-report</code> tool provided with Swift to
monitor our data dispersion ratio (ratio of objects on the proper
device / number of objects). A dedicated Openstack account is required
that will be used by <code>swift-dispersion-populate</code> to create containers
and objects.</p>
<p>Then we have to configure appropriately the <code>swift-dispersion-report</code>
tool with the <code>/etc/swift/dispersion.conf</code> file:</p>
<div class="highlight"><pre><span></span>[dispersion]
auth_url = http://SWIFT_PROXY_URL/auth/v1.0
auth_user = DEDICATED_ACCOUNT_USERNAME
auth_key = DEDICATED_ACCOUNT_PASSWORD
</pre></div>


<p>Once properly set, we can initiate dispersion monitoring by populating
our new account with test data:</p>
<div class="highlight"><pre><span></span>cloud@swproxy:~$ swift-dispersion-populate
Created <span class="m">2621</span> containers <span class="k">for</span> dispersion reporting, 4m, <span class="m">0</span> retries
Created <span class="m">2621</span> objects <span class="k">for</span> dispersion reporting, 2m, <span class="m">0</span> retries
</pre></div>


<p>Our objects should have been placed on appropriate devices. We can
check this:</p>
<div class="highlight"><pre><span></span>cloud@swproxy:~$ swift-dispersion-report
Queried <span class="m">2622</span> containers <span class="k">for</span> dispersion reporting, 2m, <span class="m">31</span> retries
100.00% of container copies found <span class="o">(</span><span class="m">7866</span> of 7866<span class="o">)</span>
Sample represents 1.00% of the container partition space
Queried <span class="m">2621</span> objects <span class="k">for</span> dispersion reporting, 45s, <span class="m">1</span> retries
There were <span class="m">2621</span> partitions missing <span class="m">0</span> copy.
100.00% of object copies found <span class="o">(</span><span class="m">7863</span> of 7863<span class="o">)</span>
Sample represents 1.00% of the object partition space
</pre></div>


<h3>Monitoring data redistribution</h3>
<p>Once updated ring has been pushed to every nodes and proxy servers, we
can follow the data redistribution with the
<code>swift-dispersion-report</code>. The migration is terminated when the number
of objects copies reach 100%. Here's an example of results obtained on
a 6 nodes cluster.</p>
<div class="highlight"><pre><span></span>cloud@swproxy:~$ swift-dispersion-report
Queried <span class="m">2622</span> containers <span class="k">for</span> dispersion reporting, 3m, <span class="m">29</span> retries
100.00% of container copies found <span class="o">(</span><span class="m">7866</span> of 7866<span class="o">)</span>
Sample represents 1.00% of the container partition space
Queried <span class="m">2621</span> objects <span class="k">for</span> dispersion reporting, 33s, <span class="m">0</span> retries
There were <span class="m">23</span> partitions missing <span class="m">0</span> copy.
There were <span class="m">2598</span> partitions missing <span class="m">1</span> copy.
66.96% of object copies found <span class="o">(</span><span class="m">5265</span> of 7863<span class="o">)</span>
Sample represents 1.00% of the object partition space

<span class="c1"># Then some minutes later</span>
cloud@swproxy:~$ swift-dispersion-report
Queried <span class="m">2622</span> containers <span class="k">for</span> dispersion reporting, 5m, <span class="m">0</span> retries
100.00% of container copies found <span class="o">(</span><span class="m">7866</span> of 7866<span class="o">)</span>
Sample represents 1.00% of the container partition space
Queried <span class="m">2621</span> objects <span class="k">for</span> dispersion reporting, 26s, <span class="m">0</span> retries
There were <span class="m">91</span> partitions missing <span class="m">0</span> copy.
There were <span class="m">2530</span> partitions missing <span class="m">1</span> copy.
67.82% of object copies found <span class="o">(</span><span class="m">5333</span> of 7863<span class="o">)</span>
Sample represents 1.00% of the object partition space
</pre></div>


<h2>Limiting the amount of data to move</h2>
<p>There has been a number of recent contributions to Swift that have
been done in order to allow the smooth addition of nodes to a new
region.</p>
<p>With versions of <code>swift-ring-builder</code> earlier than Swift 2.1, when
adding a node to a new region, 1 replica of every object was moved to
the new region in order to maximize the dispersion of objects across
different regions. Such algorithm had severe drawbacks. Let's consider
a one region Swift cluster with 100 storage nodes. Adding 1 node to a
second region had the effect of transferring 1/3 of the cluster's data
to the new node, which would not have the capacity to store the data
previously distributed over 33 nodes. So in order to add a new region
to our cluster, we had to add in 1 step enough nodes to store 1/3 of
our data. Let's consider we add 33 nodes to the new region. While
there is enough capacity on these nodes to receive 1 replica of every
objects, such operation would trigger the transfer of Petabytes of
data to the new nodes. With a 10 Gigabits/second link between the 2
datacenters, such transfer would take days if not weeks, during which
the cluster's network and destination nodes' disks would be saturated.</p>
<p>With <a href="https://review.openstack.org/#/c/115441/">commit 6d77c37</a> ("Let admins add a region without melting
their cluster"), that has been released with Swift 2.1, the number of
partitions assigned to nodes in a new region was determined by the
weights of the nodes' devices. This feature allowed a Swift cluster
operator the limit the amount of data transferred to a new
region. However, because of <a href="https://bugs.launchpad.net/swift/+bug/1367826">bug 1367826</a> ("swift-ringbuilder
rebalance moves 100% partitions when adding a new node to a new
region"), even when limiting the amount of data transferred to a new
region, a big amount of data is moved uselessly inside the initial
region. For instance, it could happen that after a <code>swift-ring-builder
rebalance</code> operation, 3% of partitions were assigned to the new
region, but 88% of partitions were reassigned to new nodes inside the
first region. The would lead to uselessly loading the cluster's
network and storage nodes.</p>
<p>Eventually, <a href="https://review.openstack.org/#/c/121422/">commit 20e9ad5</a> ("Limit partition movement when adding
a new tier") fixed <a href="https://bugs.launchpad.net/swift/+bug/1367826">bug 1367826</a>. This commit has been released
with Swift 2.2. It allows an operator to choose the amount of data
that flows between regions, when adding nodes to a new region, without
border effects. This feature enables the operator to perform a multi
steps cluster split, by first adding devices with very low weights to
a new region, then by progressively increasing the weights step by
step. This can be done until 1 replica of every objects has been
transferred to the new region. Since the number of partitions assigned
to the new region depends on the weights assigned to the new devices,
the operator has to compute the appropriate weights.</p>
<h3>Computing new region weight for a given ratio of partitions</h3>
<p>In order to assign a given ratio of partitions to a new region, a
Swift operator can compute the devices' weights by using the following
formula.</p>
<p>Given:</p>
<ul>
<li>w1 is the weight of a single device in region r1</li>
<li>r1 has n1 devices</li>
<li>W1 = n1 * w1 is the full weight of region r1</li>
<li>r2 has n2 devices</li>
<li>w2 is the weight of a single device in region r2</li>
<li>W2 = n2 * w2 is the full weight of region r2</li>
<li>r is the ratio of partitions we want in region r2</li>
</ul>
<p>We have:</p>
<ul>
<li>r = W2 / (W1+W2)</li>
<li>&lt;=&gt; W2 = r*W1 / (1-r)</li>
<li>&lt;=&gt; w2 = r<em>W1 / (1-r)</em>n2</li>
</ul>
<p>w2 is the weight to set to each device of region r2</p>
<h3>Computing new devices weight for a given number of partitions</h3>
<p>In some cases the operator may prefer to specify the number of
partitions (rather than its ratio) that he wishes to assign to the
devices of a new region.</p>
<p>Given:</p>
<ul>
<li>p1 the number of partitions in region r1</li>
<li>W1 the full weight of region r1</li>
<li>p2 the number of partitions in region r2</li>
<li>W2 the full weight of region r2</li>
</ul>
<p>We have the following equality:</p>
<ul>
<li>p1/W1 = p2/W2</li>
<li>&lt;=&gt; W2 = W1*p2 / p1</li>
<li>&lt;=&gt; w2 = W1<em>p2 / n2</em>p1</li>
</ul>
<p>w2 is the weight to set to each device of region r2</p>
<h3>Some scripts to compute weights automatically</h3>
<p>I made some <a href="https://github.com/FlorentFlament/swift-scripts">Swift scripts</a> available to facilitate adding nodes to
a new region. <code>swift-add-nodes.py</code> allows adding nodes to a new region
with a minimal weight so that only 1 partition will be assigned to
each device (The number and names of devices is set in a constant at
the beginning of the script and has to be updated). Then
<code>swift-assign-partitions.py</code> allows assigning a chosen ratio of
partitions to the new region.</p>
<h2>Example of deployment</h2>
<p>Here's an example of the steps that a Swift operator can follow in
order to split its one region cluster into 2 regions smoothly. A first
step may consist in adding some new nodes to the new region and
assigning 1 partition to each device. This would typically move
between hundreds of Megabytes to a few Gigabytes; thus allowing to
check that everything (network, hardware, ...) is working as
expected. We can use the <code>swift-add-nodes.py</code> script to easily add
nodes to our new region with a minimal weight so that only 1 partition
will be assigned to each device:</p>
<div class="highlight"><pre><span></span>$ python swift-add-nodes.py object.builder object.builder.s1 <span class="m">2</span> <span class="m">6000</span> 127.0.0.1 127.0.0.2 127.0.0.3
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.1&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdb1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.1&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdc1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.1&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdd1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.1&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sde1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.2&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdb1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.2&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdc1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.2&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdd1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.2&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sde1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.3&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdb1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.3&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdc1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.3&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sdd1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>
Adding device: <span class="o">{</span><span class="s1">&#39;weight&#39;</span>: 5.11, <span class="s1">&#39;zone&#39;</span>: 0, <span class="s1">&#39;ip&#39;</span>: <span class="s1">&#39;127.0.0.3&#39;</span>, <span class="s1">&#39;region&#39;</span>: 2, <span class="s1">&#39;device&#39;</span>: <span class="s1">&#39;sde1&#39;</span>, <span class="s1">&#39;port&#39;</span>: 6000<span class="o">}</span>

$ swift-ring-builder object.builder.s1 rebalance
Reassigned <span class="m">12</span> <span class="o">(</span>0.00%<span class="o">)</span> partitions. Balance is now 0.18.
</pre></div>


<p>Subsequent steps may consist in increasing the partitions count by
steps of some percentage (let's say 3%) until one third of total
cluster data is stored in the new region. Script
<code>swift-assign-partitions.py</code> allows assigning a chosen ratio of
partitions to the new region:</p>
<div class="highlight"><pre><span></span>$ python swift-assign-partitions.py object.builder.s2 object.builder.s3 <span class="m">2</span> 0.03
Setting new weight of 10376.28 to device 1342
Setting new weight of 10376.28 to device 1343
Setting new weight of 10376.28 to device 1344
Setting new weight of 10376.28 to device 1345
Setting new weight of 10376.28 to device 1346
Setting new weight of 10376.28 to device 1347
Setting new weight of 10376.28 to device 1348
Setting new weight of 10376.28 to device 1349
Setting new weight of 10376.28 to device 1350
Setting new weight of 10376.28 to device 1351
Setting new weight of 10376.28 to device 1352
Setting new weight of 10376.28 to device 1353

$ swift-ring-builder object.builder.s3 rebalance
Reassigned <span class="m">25119</span> <span class="o">(</span>9.58%<span class="o">)</span> partitions. Balance is now 0.25.
</pre></div>


<h2>Thanks &amp; related links</h2>
<p>Special thanks to Christian Schwede for the awesome work he did to
improve the <code>swift-ring-builder</code>.</p>
<p>Interested in more details about <a href="http://www.florentflament.com/blog/openstack-swift-ring-made-understandable.html">how Openstack Swift Ring is
working</a> ?</p>
<p>Want to know more about all of this ? Come to see our talk <a href="https://openstacksummitnovember2014paris.sched.org/event/15afea20487919ec1e55c7f385df3f68#.VEVpSoXzTFY">Using
OpenStack Swift for Extreme Data Durability</a> at the next OpenStack
Summit in Paris !</p>
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "splitting-swift-cluster.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://florentflament.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://blog.chmouel.com/"><i class="icon-external-link"></i>Chmouel's Blog</a></li>
    <li><a href="http://dachary.org/"><i class="icon-external-link"></i>Lo√Øc Dachary's Blog</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/misc.html">
    <i class="icon-folder-open icon-large"></i>misc
</a>
</li>
<li>
<a href="./category/openstack.html">
    <i class="icon-folder-open icon-large"></i>OpenStack
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-2">
    <a href="./tag/ay-3-8910.html">
        <i class="icon-tag icon-large"></i>AY-3-8910
    </a>
</li>
<li class="tag-4">
    <a href="./tag/apple.html">
        <i class="icon-tag icon-large"></i>Apple
    </a>
</li>
<li class="tag-2">
    <a href="./tag/arduino.html">
        <i class="icon-tag icon-large"></i>Arduino
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ceph.html">
        <i class="icon-tag icon-large"></i>Ceph
    </a>
</li>
<li class="tag-4">
    <a href="./tag/chef.html">
        <i class="icon-tag icon-large"></i>Chef
    </a>
</li>
<li class="tag-2">
    <a href="./tag/cinder.html">
        <i class="icon-tag icon-large"></i>Cinder
    </a>
</li>
<li class="tag-2">
    <a href="./tag/costs.html">
        <i class="icon-tag icon-large"></i>Costs
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-safety.html">
        <i class="icon-tag icon-large"></i>Data Safety
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-security.html">
        <i class="icon-tag icon-large"></i>Data Security
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-management.html">
        <i class="icon-tag icon-large"></i>Data management
    </a>
</li>
<li class="tag-2">
    <a href="./tag/docker.html">
        <i class="icon-tag icon-large"></i>Docker
    </a>
</li>
<li class="tag-4">
    <a href="./tag/git.html">
        <i class="icon-tag icon-large"></i>Git
    </a>
</li>
<li class="tag-4">
    <a href="./tag/hardware.html">
        <i class="icon-tag icon-large"></i>Hardware
    </a>
</li>
<li class="tag-4">
    <a href="./tag/irc.html">
        <i class="icon-tag icon-large"></i>IRC
    </a>
</li>
<li class="tag-4">
    <a href="./tag/kvm.html">
        <i class="icon-tag icon-large"></i>KVM
    </a>
</li>
<li class="tag-2">
    <a href="./tag/keystone.html">
        <i class="icon-tag icon-large"></i>Keystone
    </a>
</li>
<li class="tag-4">
    <a href="./tag/linux.html">
        <i class="icon-tag icon-large"></i>Linux
    </a>
</li>
<li class="tag-4">
    <a href="./tag/microsft.html">
        <i class="icon-tag icon-large"></i>Microsft
    </a>
</li>
<li class="tag-1">
    <a href="./tag/openstack.html">
        <i class="icon-tag icon-large"></i>OpenStack
    </a>
</li>
<li class="tag-4">
    <a href="./tag/policies.html">
        <i class="icon-tag icon-large"></i>Policies
    </a>
</li>
<li class="tag-4">
    <a href="./tag/printers.html">
        <i class="icon-tag icon-large"></i>Printers
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspberry-pi.html">
        <i class="icon-tag icon-large"></i>Raspberry Pi
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspbian.html">
        <i class="icon-tag icon-large"></i>Raspbian
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ring.html">
        <i class="icon-tag icon-large"></i>Ring
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ssh.html">
        <i class="icon-tag icon-large"></i>SSH
    </a>
</li>
<li class="tag-2">
    <a href="./tag/swift.html">
        <i class="icon-tag icon-large"></i>Swift
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ubuntu.html">
        <i class="icon-tag icon-large"></i>Ubuntu
    </a>
</li>
<li class="tag-4">
    <a href="./tag/vm.html">
        <i class="icon-tag icon-large"></i>VM
    </a>
</li>
<li class="tag-4">
    <a href="./tag/virtualization.html">
        <i class="icon-tag icon-large"></i>Virtualization
    </a>
</li>
<li class="tag-4">
    <a href="./tag/windows.html">
        <i class="icon-tag icon-large"></i>Windows
    </a>
</li>
<li class="tag-2">
    <a href="./tag/ym2149.html">
        <i class="icon-tag icon-large"></i>YM2149
    </a>
</li>
<li class="tag-2">
    <a href="./tag/ym2149f.html">
        <i class="icon-tag icon-large"></i>YM2149F
    </a>
</li>
<li class="tag-4">
    <a href="./tag/znc.html">
        <i class="icon-tag icon-large"></i>ZNC
    </a>
</li>
<li class="tag-4">
    <a href="./tag/bug.html">
        <i class="icon-tag icon-large"></i>bug
    </a>
</li>
<li class="tag-4">
    <a href="./tag/libvirt.html">
        <i class="icon-tag icon-large"></i>libvirt
    </a>
</li>
<li class="tag-4">
    <a href="./tag/operations.html">
        <i class="icon-tag icon-large"></i>operations
    </a>
</li>

<li class="nav-header">
<a href="https://twitter.com/florentflament_" class="twitter-follow-button" data-show-count="false">Follow @florentflament_</a>
</li>
<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
        </address><!-- /#about -->
        <p>Powered by <a href="http://blog.getpelican.com/">Pelican<i class="icon-external-link"></i></a></p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-23791515-4");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'florentflament';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>