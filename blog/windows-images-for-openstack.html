<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Windows Images for OpenStack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Florent Flament">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Florent Flament's Tech Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Florent Flament's Tech Blog </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/misc.html">
						<i class="icon-folder-open icon-large"></i>misc
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/openstack.html">
						<i class="icon-folder-open icon-large"></i>OpenStack
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Windows Images for OpenStack">
                                        Windows Images for OpenStack
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-03-30T19:15:00">
        <i class="icon-calendar"></i>Sun 30 March 2014
</abbr>
<span class="label">By</span>
<a href="./author/florent-flament.html"><i class="icon-user"></i>Florent Flament</a>
<span class="label">Category</span>
<a href="./category/openstack.html"><i class="icon-folder-open"></i>OpenStack</a>.


<span class="label">Tags</span>
	<a href="./tag/openstack.html"><i class="icon-tag"></i>OpenStack</a>
	<a href="./tag/microsft.html"><i class="icon-tag"></i>Microsft</a>
	<a href="./tag/windows.html"><i class="icon-tag"></i>Windows</a>
</footer><!-- /.post-info -->                </div>
                <p>This note summarizes articles from other places about Microsoft
Windows images for OpenStack creation, along with some first hand
experience. The whole process of creating Windows 2008 and Windows
2012 images fully usable on OpenStack instances is described there.</p>
<h1>Prerequisite</h1>
<p>To achieve the creation of a qcow2 Windows image for OpenStack, we
need the following ISO images:</p>
<ul>
<li>
<p>An ISO image of the installation DVD for all OSes that we wish to
  use in OpenStack. These ISOs can usually be downloaded from a
  company's account on Microsoft website, once the appropriate
  contract has been signed. For testing purpose, <a href="http://technet.microsoft.com/en-us/evalcenter/hh670538.aspx">Windows Server 2012
  Evaluation ISO</a> can be downloaded on Microsoft website.</p>
</li>
<li>
<p>The latest <a href="http://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers">VirtIO drivers for Windows</a>. These are optimized
  drivers to run Windows OSes with KVM virtualized hard disk
  controller and network devices.</p>
</li>
</ul>
<h1>Base image creation</h1>
<p>The first step to build a Microsoft Windows image is to install the OS
in a VM as we would have done on a bare metal computer. <a href="http://blog.gridcentric.com/bid/297627/Creating-a-Windows-Image-on-OpenStack">Gridcentric's
article about Windows image creation</a> describes this procedure in
details.</p>
<p>The steps to follow are:</p>
<ul>
<li>
<p>Create an empty qcow2 image (this will be the disk on which we'll
  install our OS). I typically use a 9 GB image for Windows 2008, and
  a 17 GB for Windows 2012 (although I think it should work with a 11
  or 12 GB image). Example:</p>
<div class="highlight"><pre><span class="nv">$ </span>qemu-img create -f qcow2 Windows-Server-2008-R2.qcow2 9G
</pre></div>


</li>
<li>
<p>Next step is to launch Windows' installation in a (KVM) virtual
  machine. The following command is an example for that:</p>
<div class="highlight"><pre><span class="nv">$ </span>kvm <span class="se">\</span>
    -m 2048 <span class="se">\</span>
    -cdrom &lt;WINDOWS_INSTALLER_ISO&gt; <span class="se">\</span>
    -drive <span class="nv">file</span><span class="o">=</span>Windows-Server-2008-R2.qcow2,if<span class="o">=</span>virtio <span class="se">\</span>
    -drive <span class="nv">file</span><span class="o">=</span>&lt;VIRTIO_DRIVERS_ISO&gt;,index<span class="o">=</span>3,media<span class="o">=</span>cdrom <span class="se">\</span>
    -net nic,model<span class="o">=</span>virtio <span class="se">\</span>
    -net user <span class="se">\</span>
    -nographic <span class="se">\</span>
    -vnc :9 <span class="se">\</span>
    -k fr <span class="se">\</span>
    -usbdevice tablet
</pre></div>


</li>
<li>
<p>The following step consists in connecting to the display of the VM
  launched previously through VNC, in order to manually pursue the
  installation. This can be done with the following command:</p>
<div class="highlight"><pre><span class="nv">$ </span>xvncviewer &lt;IP_OF_HYPERVISOR&gt;:9
</pre></div>


</li>
<li>
<p>During the installation, Windows will ask for the Hard Disk
  controller driver. We have to select the VirtIO driver, which is
  located on the VirtIO CDROM (WIN7 directory for Windows 2008,
  and WIN8 directory for Windows 2012).</p>
</li>
<li>
<p>Once the basic Windows installation is done, we have to set the
  appropriate Network device driver in the Windows Devices
  Manager. The Network device VirtIO driver is available in the same
  directory than the Hard Disk controller driver specified in the
  previous step.</p>
</li>
<li>
<p>Since VMs will be managed by RDP, we have to activate the
  service. This is done by navigating through the following menu:
  Computer (right-lick) -&gt; Properties -&gt; remote tab, and selecting the
  following option: allow connections from computers running any
  version of Remote Desktop.</p>
</li>
<li>
<p>An additional step consisting in opening the appropriate Firewall
  ports is required on Windows 2012: Network (right-click) -&gt;
  Properties -&gt; Windows Firewall -&gt; Advanced Settings -&gt; Inbound
  rules. Then enable: Remote Desktop - Shadow, Remote Desktop - User
  Mode TCP, Remote Desktop - User Mode UDP.</p>
</li>
</ul>
<h1>Customizing image for OpenStack</h1>
<p>The previous steps allowed us to have Windows fully installed in a KVM
virtual machine. The last steps consist in installing <a href="http://www.cloudbase.it/cloud-init-for-windows-instances/">Cloud-Init for
Windows</a>, a Windows implementation of the Linux based
<a href="http://cloudinit.readthedocs.org/en/latest/">Cloud-Init</a> mechanism. This set of scripts transforms a legacy OS
image into a ready for OpenStack image. At instantiation of a VM,
Cloud-Init fetches from a meta-data server, data such as ssh public
key and hostname that allows the instance to become unique. Cloud-Init
base is Open source, and Cloudbase provides an <a href="https://www.cloudbase.it/downloads/CloudbaseInitSetup_Beta.msi">installer</a> on its
blog. We'll install Cloud-Init by injecting the installer that we just
downloaded. To to that, we have to follow these steps:</p>
<ul>
<li>
<p>Shutdown Windows</p>
</li>
<li>
<p>Mount the qcow2 image on the hypervisor filesystem, then copy the
  installer on Windows' administrator desktop, with something like:</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo qemu-nbd -c /dev/nbd2 Windows-Server-2008-R2.qcow2
<span class="nv">$ </span>sudo mount /dev/nbd2p2 mnt/
<span class="nv">$ </span>cp &lt;INSTALLER&gt; &lt;ADMINISTRATOR_DESKTOP_ON_WINDOWS&gt;
<span class="nv">$ </span>sudo umount mnt/
<span class="nv">$ </span>sudo qemu-nbd -d /dev/nbd2
</pre></div>


</li>
<li>
<p>Restart Windows in KVM with the same command that we used to install
  Windows in the first place:</p>
<div class="highlight"><pre><span class="nv">$ </span>kvm <span class="se">\</span>
    -m 2048 <span class="se">\</span>
    -cdrom &lt;WINDOWS_INSTALLER_ISO&gt; <span class="se">\</span>
    -drive <span class="nv">file</span><span class="o">=</span>Windows-Server-2008-R2.qcow2,if<span class="o">=</span>virtio <span class="se">\</span>
    -drive <span class="nv">file</span><span class="o">=</span>&lt;VIRTIO_DRIVERS_ISO&gt;,index<span class="o">=</span>3,media<span class="o">=</span>cdrom <span class="se">\</span>
    -net nic,model<span class="o">=</span>virtio <span class="se">\</span>
    -net user <span class="se">\</span>
    -nographic <span class="se">\</span>
    -vnc :9 <span class="se">\</span>
    -k fr <span class="se">\</span>
    -usbdevice tablet
</pre></div>


</li>
<li>
<p>Then connect again with xvncviewer:</p>
<div class="highlight"><pre><span class="nv">$ </span>xvncviewer &lt;IP_OF_HYPERVISOR&gt;:9
</pre></div>


</li>
<li>
<p>This time, we have to launch the CloudbaseInitSetup_Beta.msi
  installer, and follow the instructions as described on <a href="http://www.cloudbase.it/cloud-init-for-windows-instances/">Cloudbase
  blog</a>. At the end of the installation, we have to check the "run
  sysprep" option, but not the "shutdown" one. Sysprep is the tool
  provided by Microsoft to make a VM unique (generates a unique OS ID
  to be used for some Microsoft services), once it's instantiated.</p>
</li>
<li>
<p>Once the installation is done, we can clean any temporary files
  created, then shutdown the system. The image is ready to be uploaded
  in OpenStack Glance:</p>
<div class="highlight"><pre><span class="nv">$ </span>glance add <span class="nv">name</span><span class="o">=</span>&lt;OPENSTACK_IMAGE_NAME&gt; <span class="nv">is_public</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nv">container_format</span><span class="o">=</span>bare <span class="nv">disk_format</span><span class="o">=</span>qcow2 &lt; &lt;IMAGE_FILENAME&gt;
</pre></div>


</li>
</ul>
<h1>Connecting to a Windows VM</h1>
<p>The usual mechanism used in OpenStack to connect to VMs (running
Linux) is ssh. A public key specified by the user launching the VM is
set in the default user's <code>authorized_keys</code> file. This allows the user
to connect to the VM by using the corresponding private key.</p>
<p>However, it is not currently possible to connect to a Windows VM with
ssh (there is some <a href="http://www.cloudbase.it/windows-without-passwords-in-openstack/">work done in this direction</a> that I've not
tested yet). Cloud-Init base creates an <code>Admin</code> user, with either:</p>
<ul>
<li>
<p>a password specified by the user on the command line. Note that the
  password must respect Windows password strength constraints (upper
  and lower case characters, as well as numbers). If not it will be
  silently ignored. For instance:</p>
<div class="highlight"><pre><span class="nv">$ </span>nova boot --key-name &lt;KEYPAIR_NAME&gt; --image &lt;IMAGE_ID&gt; <span class="se">\</span>
    --flavor &lt;FLAVOR_ID&gt; --nic net-id<span class="o">=</span>&lt;NET_ID&gt; <span class="se">\</span>
    --meta <span class="nv">admin_pass</span><span class="o">=</span>&lt;ADMIN_PASSWORD&gt; &lt;VM_NAME&gt;
</pre></div>


</li>
<li>
<p>a password automatically generated during VM instantiation, and
  encrypted with the ssh public key provided when launching the
  VM. Such password can be retrieved and decrypted with the
  corresponding private ssh key, by using the following command (note
  that the private key is used locally):</p>
<div class="highlight"><pre><span class="nv">$ </span>nova get-password &lt;VM_NAME_OR_ID&gt; &lt;SSH_PRIVATE_KEY&gt;
</pre></div>


</li>
</ul>
<p>Note that to connect to a Windows VM from Linux, prefer using
<code>xfreerdp</code> instead of <code>rdesktop</code>. The pointer is bogus when connecting
to a windows 2012 VM using <code>rdesktop</code>.</p>
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "windows-images-for-openstack.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://florentflament.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://adam.younglogic.com/"><i class="icon-external-link"></i>Adam Young's Web Log</a></li>
    <li><a href="http://blog.chmouel.com/"><i class="icon-external-link"></i>Chmouel's Blog</a></li>
    <li><a href="http://dev.cloudwatt.com/en/blog/"><i class="icon-external-link"></i>Cloudwatt's Tech Blog</a></li>
    <li><a href="http://www.jamielennox.net/"><i class="icon-external-link"></i>Jamie Lennox's Blog</a></li>
    <li><a href="http://dachary.org/"><i class="icon-external-link"></i>Lo√Øc Dachary's Blog</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/misc.html">
    <i class="icon-folder-open icon-large"></i>misc
</a>
</li>
<li>
<a href="./category/openstack.html">
    <i class="icon-folder-open icon-large"></i>OpenStack
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-4">
    <a href="./tag/microsft.html">
        <i class="icon-tag icon-large"></i>Microsft
    </a>
</li>
<li class="tag-4">
    <a href="./tag/kvm.html">
        <i class="icon-tag icon-large"></i>KVM
    </a>
</li>
<li class="tag-4">
    <a href="./tag/apple.html">
        <i class="icon-tag icon-large"></i>Apple
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-security.html">
        <i class="icon-tag icon-large"></i>Data Security
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ceph.html">
        <i class="icon-tag icon-large"></i>Ceph
    </a>
</li>
<li class="tag-4">
    <a href="./tag/windows.html">
        <i class="icon-tag icon-large"></i>Windows
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspberry-pi.html">
        <i class="icon-tag icon-large"></i>Raspberry Pi
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-safety.html">
        <i class="icon-tag icon-large"></i>Data Safety
    </a>
</li>
<li class="tag-4">
    <a href="./tag/raspbian.html">
        <i class="icon-tag icon-large"></i>Raspbian
    </a>
</li>
<li class="tag-4">
    <a href="./tag/libvirt.html">
        <i class="icon-tag icon-large"></i>libvirt
    </a>
</li>
<li class="tag-1">
    <a href="./tag/openstack.html">
        <i class="icon-tag icon-large"></i>OpenStack
    </a>
</li>
<li class="tag-4">
    <a href="./tag/ubuntu.html">
        <i class="icon-tag icon-large"></i>Ubuntu
    </a>
</li>
<li class="tag-2">
    <a href="./tag/cinder.html">
        <i class="icon-tag icon-large"></i>Cinder
    </a>
</li>
<li class="tag-4">
    <a href="./tag/chef.html">
        <i class="icon-tag icon-large"></i>Chef
    </a>
</li>
<li class="tag-4">
    <a href="./tag/irc.html">
        <i class="icon-tag icon-large"></i>IRC
    </a>
</li>
<li class="tag-4">
    <a href="./tag/data-management.html">
        <i class="icon-tag icon-large"></i>Data management
    </a>
</li>
<li class="tag-4">
    <a href="./tag/policies.html">
        <i class="icon-tag icon-large"></i>Policies
    </a>
</li>
<li class="tag-4">
    <a href="./tag/bug.html">
        <i class="icon-tag icon-large"></i>bug
    </a>
</li>
<li class="tag-4">
    <a href="./tag/linux.html">
        <i class="icon-tag icon-large"></i>Linux
    </a>
</li>
<li class="tag-4">
    <a href="./tag/docker.html">
        <i class="icon-tag icon-large"></i>Docker
    </a>
</li>
<li class="tag-4">
    <a href="./tag/znc.html">
        <i class="icon-tag icon-large"></i>ZNC
    </a>
</li>
<li class="tag-2">
    <a href="./tag/keystone.html">
        <i class="icon-tag icon-large"></i>Keystone
    </a>
</li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
        </address><!-- /#about -->
        <p>Powered by <a href="http://blog.getpelican.com/">Pelican<i class="icon-external-link"></i></a></p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-23791515-4");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'florentflament';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>